name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkout DBCD Library
        uses: actions/checkout@v4
        with:
          repository: wowdev/DBCD
          path: dbcd-lib
          fetch-depth: 1

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Build Release
        run: dotnet build dbc-localizer -c Release

      - name: Prepare Release Package
        shell: powershell
        run: |
          $version = "${{ github.ref }}" -replace 'refs/tags/', ''
          $zipName = "dbc-localizer-$version-win-x64.zip"
          
          Write-Host "Starting release packaging..."
          Write-Host "Version: $version"
          Write-Host "ZIP Name: $zipName"
          Write-Host "Current directory: $(Get-Location)"
          
          # Check if bin/Release exists
          if (!(Test-Path "bin/Release")) {
            Write-Host "ERROR: bin/Release directory not found!"
            exit 1
          }
          
          # List contents of bin/Release
          Write-Host "Contents of bin/Release:"
          Get-ChildItem -Path "bin/Release" -Recurse | ForEach-Object { Write-Host "  $_" }
          
          # Create temporary directory for packaging
          $stagingDir = "release-staging"
          if (Test-Path $stagingDir) { Remove-Item -Recurse -Force $stagingDir }
          New-Item -ItemType Directory -Path $stagingDir | Out-Null
          Write-Host "Created staging directory: $stagingDir"
          
          # Copy release artifacts
          Write-Host "Copying artifacts from bin/Release to staging..."
          Copy-Item -Path "bin/Release/*" -Destination "$stagingDir/" -Recurse -Force -ErrorAction Stop
          
          # List staging contents
          Write-Host "Staging directory contents:"
          Get-ChildItem -Path $stagingDir -Recurse | ForEach-Object { Write-Host "  $_" }
          
          # Create ZIP file
          Write-Host "Creating ZIP file: $zipName"
          $compressParams = @{
            Path = "$stagingDir/*"
            DestinationPath = $zipName
            CompressionLevel = "Optimal"
            Force = $true
            ErrorAction = "Stop"
          }
          Compress-Archive @compressParams
          
          # Verify ZIP was created
          if (Test-Path $zipName) {
            $zipSize = (Get-Item $zipName).Length
            Write-Host "ZIP created successfully: $zipName ($zipSize bytes)"
          } else {
            Write-Host "ERROR: ZIP file was not created!"
            exit 1
          }
          
          # Cleanup staging directory
          Remove-Item -Recurse -Force $stagingDir
          Write-Host "Cleaned up staging directory"
          
          # List files in current directory
          Write-Host "Files in current directory:"
          Get-ChildItem -Path "." -File | ForEach-Object { Write-Host "  $_" }

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: dbc-localizer-*.zip
          retention-days: 1

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dbc-localizer-*.zip
          draft: false
          prerelease: false
          body: |
            ## WoW DBC Localizer Release
            
            Windows x64 Release Package
            
            ### Contents
            - `dbc-localizer.exe` - Main executable (with WoW icon)
            - `config.json` - Configuration template
            - `lib/` - Required .NET dependencies
            - `input/` - Input directory for DBC/MPQ files
            - `output/` - Output directory for processed files
            - `tools/` - Helper tools (mpqcli)
            
            ### Usage
            ```
            dbc-localizer localize <input.dbc> <output.dbc> <field_mapping.json>
            dbc-localizer localize-mpq <input.mpq> <output.mpq> <field_mapping.json>
            dbc-localizer scan-mpq <input.mpq>
            ```
            
            For more information, see [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
