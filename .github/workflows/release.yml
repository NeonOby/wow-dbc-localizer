name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Build Release
        run: dotnet build dbc-localizer -c Release

      - name: Prepare Release Package
        shell: powershell
        run: |
          $version = "${{ github.ref }}" -replace 'refs/tags/', ''
          $zipName = "dbc-localizer-$version-win-x64.zip"
          
          # Create temporary directory for packaging
          $stagingDir = "release-staging"
          if (Test-Path $stagingDir) { Remove-Item -Recurse -Force $stagingDir }
          New-Item -ItemType Directory -Path $stagingDir | Out-Null
          
          # Copy release artifacts
          Copy-Item -Path "bin/Release/*" -Destination "$stagingDir/" -Recurse -Force
          
          # Create ZIP file
          Compress-Archive -Path "$stagingDir/*" -DestinationPath $zipName -CompressionLevel Optimal -Force
          
          # Cleanup staging directory
          Remove-Item -Recurse -Force $stagingDir
          
          # Save version for next step
          "$version" | Out-File -FilePath "version.txt" -NoNewline
          Write-Host "Release package created: $zipName"

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: dbc-localizer-*.zip
          retention-days: 1

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dbc-localizer-*.zip
          draft: false
          prerelease: false
          body: |
            ## WoW DBC Localizer Release
            
            Windows x64 Release Package
            
            ### Contents
            - `dbc-localizer.exe` - Main executable (with WoW icon)
            - `config.json` - Configuration template
            - `lib/` - Required .NET dependencies
            - `input/` - Input directory for DBC/MPQ files
            - `output/` - Output directory for processed files
            - `tools/` - Helper tools (mpqcli)
            
            ### Usage
            ```
            dbc-localizer localize <input.dbc> <output.dbc> <field_mapping.json>
            dbc-localizer localize-mpq <input.mpq> <output.mpq> <field_mapping.json>
            dbc-localizer scan-mpq <input.mpq>
            ```
            
            For more information, see [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
